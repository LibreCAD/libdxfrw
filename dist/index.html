<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Read File Content</title>
</head>
<body>
    <h1>Select a DXF/DWG file</h1>
    <input type="file" id="fileInput" accept=".dxf, .dwg" />
    <button id="convertBtn" disabled>Convert DWG to DXF</button>

    <!-- Element to display Layer Names -->
    <h2>Layer Names:</h2>
    <ul id="layerNamesList"></ul>

    <!-- Element to display Line Types -->
    <h2>Line Types:</h2>
    <ul id="lineTypesList"></ul>

    <!-- Element to display Text Styles -->
    <h2>Text Styles:</h2>
    <ul id="textStylesList"></ul>

    <!-- Element to display Dimensionn Styles -->
    <h2>Dimension Styles:</h2>
    <ul id="dimStylesList"></ul>

    <!-- Element to display Viewports -->
    <h2>Viewports:</h2>
    <ul id="viewportsList"></ul>

    <!-- Element to display Blocks -->
    <h2>Blocks:</h2>
    <ul id="blocksList"></ul>

    <!-- Element to display Blocks -->
    <h2>Images:</h2>
    <ul id="imagesList"></ul>

    <script>
        // Create a flag to check if the module is initialized
        let isModuleInitialized = false;

        // Define the Module object
        var Module = {
            onRuntimeInitialized: function() {
                isModuleInitialized = true;
                console.log('WebAssembly module initialized');
            }
        };

        var printItems = (id, items, itemName = 'name', subItemName = undefined) => {
            // Clear previous item list
            const listElement = document.getElementById(id);
            listElement.innerHTML = '';

            // Create list item for item
            for (let index = 0, size = items.size(); index < size; ++index) {
                const item = items.get(index);
                const li = document.createElement('li');
                if (subItemName) {
                    li.textContent = `${item[itemName]}: ${item[subItemName].size()}`;
                } else {
                    li.textContent = item[itemName];
                }
                listElement.appendChild(li);
            }
        }

        const fileInput = document.getElementById('fileInput');
        const convertButton = document.getElementById('convertBtn');

        // Function to convert DWG to DXF after clicking the button
        convertButton.addEventListener('click', function () {
            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(event) {
                const fileContent = event.target.result;

                // Parse DWG file 
                const data = new Module.dx_data();
                const iface = new Module.dx_iface();
                iface.cData = data;
                if (!iface.fileImport(fileContent, data, false, false)) {
                    console.error('Failed to parse the selected file!');
                }

                // Write as DXF string
                const dxfContent = iface.fileExport(Module.DRW_Version.AC1021, false, data, true);

                // Manually signal that a C++ object is no longer needed and can be deleted.
                data.delete();
                iface.delete();

                // Create a new Blob with the file content
                const blob = new Blob([dxfContent], { type: 'text/plain' });
                
                // Create a link element to trigger the download
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'converted.dxf'; // The name of the new file

                // Trigger the file download
                link.click();
            };

            // Read the selected file as an ArrayBuffer (binary data)
            reader.readAsArrayBuffer(file);
        });

        // Function to handle file input change event
        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            
            if (file) {
                // Get file extension
                const fileExtension = file.name.split('.').pop().toLowerCase();

                // Create a FileReader to read the file
                const reader = new FileReader();

                // Define the callback function for when the file is read
                reader.onload = function(e) {
                    const fileContent = e.target.result;

                    // Wait for the WebAssembly module to be initialized
                    if (isModuleInitialized) {
                        try {
                            const data = new Module.dx_data();
                            const iface = new Module.dx_iface();
                            iface.cData = data;

                            if (fileExtension == 'dxf') {
                                const dxf = new Module.dxfRW(fileContent);

                                // Uncomment out the following line if you want to show debug info
                                // dxf.setDebug(Module.DRW_dbg_Level.Debug);

                                const result = dxf.read(iface, false);

                                // Manually signal that a C++ object is no longer needed and can be deleted.
                                dxf.delete();
                            } else if (fileExtension == 'dwg') {
                                const dwg = new Module.dwgR(fileContent);

                                // Uncomment out the following line if you want to show debug info
                                // dwg.setDebug(Module.DRW_dbg_Level.Debug);

                                const result = dwg.read(iface, false);

                                // Manually signal that a C++ object is no longer needed and can be deleted.
                                dwg.delete();

                                convertButton.disabled = false;
                            }

                            printItems('layerNamesList', iface.cData.layers);
                            printItems('lineTypesList', iface.cData.lineTypes);
                            printItems('textStylesList', iface.cData.textStyles);
                            printItems('dimStylesList', iface.cData.dimStyles);
                            printItems('viewportsList', iface.cData.viewports);
                            printItems('blocksList', iface.cData.blocks, 'name', 'ent');
                            printItems('imagesList', iface.cData.images, 'path');

                            // Manually signal that a C++ object is no longer needed and can be deleted.
                            data.delete();
                            iface.delete();
                        } catch (error) {
                            console.error('Error processing DXF/DWG file: ', error);
                        }
                    } else {
                        console.error('WebAssembly module not yet initialized');
                    }
                };

                // Read the file
                if (fileExtension == 'dxf') {
                    reader.readAsText(file);
                } else if (fileExtension == 'dwg') {
                    reader.readAsArrayBuffer(file);
                }
            } else {
                convertButton.disabled = true;
                console.log('No file selected');
            }
        });


    </script>
    <script src="libdxfrw.js"></script>
</body>
</html>
